# Next.js 接入 Adsterra 广告最佳实践

> **核心结论**: 使用 iframe 嵌入独立 HTML 文件是在 Next.js/React 中集成 Adsterra 广告的最可靠方案。

---

## 一、为什么不能直接使用 Next.js Script 组件？

### 问题 1: `beforeInteractive` 策略的限制
- **官方限制**: `beforeInteractive` 只在 `app/layout.tsx` 或 `pages/_document.js` 中生效
- **组件中失效**: 在普通组件中使用会被自动降级为 `afterInteractive`
- **后果**: 配置脚本（`atOptions`）可能在 `invoke.js` 之后执行，导致广告不显示

### 问题 2: React 对 `<script>` 标签的过滤
- **安全机制**: React 会过滤掉 JSX 中直接写的 `<script>` 标签（防止 XSS）
- **内联脚本不执行**: 即使使用 `dangerouslySetInnerHTML`，内联 JavaScript 也不会执行
- **Hydration 错误**: 原生 `<script>` 标签会导致服务端/客户端 HTML 不匹配

### 问题 3: Adsterra 的严格执行顺序要求
- **必须先设置 `window.atOptions`**: Adsterra 的 `invoke.js` 期望在加载时 `atOptions` 已存在
- **同页多广告冲突**: 多个广告共用全局 `window.atOptions`，后加载的会覆盖先加载的
- **顺序混乱**: Next.js Script 组件无法保证多个脚本的执行顺序

### 问题 4: 位置控制困难
- **Script 组件策略**: `afterInteractive` 策略会将脚本注入到 `</body>` 之前
- **广告飞到底部**: 广告可能出现在页面底部，而不是预期位置
- **无法精确控制**: 难以将广告放置在页面的特定区域

---

## 二、iframe 方案详解

### 核心原理

**完全隔离**: iframe 创建一个独立的浏览器上下文，内部的 JavaScript 不受外部 React/Next.js 影响。

```
┌─────────────────────────────────────┐
│  Next.js 页面 (React 组件)           │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ <iframe src="/ads/xxx.html">  │ │
│  │                               │ │
│  │  ┌─────────────────────────┐ │ │
│  │  │  独立的 HTML 文档         │ │ │
│  │  │  - atOptions 设置       │ │ │
│  │  │  - invoke.js 加载       │ │ │
│  │  │  - 广告渲染             │ │ │
│  │  └─────────────────────────┘ │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 实施步骤

#### 步骤 1: 创建广告 HTML 文件

在 `public/ads/` 目录下为每种广告尺寸创建独立的 HTML 文件。

**目录结构**:
```
public/
└── ads/
    ├── banner-468x60.html
    ├── banner-300x250.html
    ├── banner-160x600.html
    └── banner-160x300.html
```

**HTML 模板** (`public/ads/banner-468x60.html`):
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adsterra 468x60 Banner</title>
</head>
<body style="padding: 0; margin: 0;">
  <!-- 1. 先设置 atOptions -->
  <script type="text/javascript">
    atOptions = {
      'key': '你的广告KEY',
      'format': 'iframe',
      'height': 60,
      'width': 468,
      'params': {}
    };
  </script>

  <!-- 2. 再加载 invoke.js -->
  <script type="text/javascript" src="//www.highperformanceformat.com/你的KEY/invoke.js"></script>
</body>
</html>
```

**关键配置说明**:
- `'key'`: 从 Adsterra 后台获取的唯一广告 ID
- `'format': 'iframe'`: 固定值，表示横幅广告
- `'height'` / `'width'`: 广告尺寸（必须与 Adsterra 后台设置一致）
- `body style="padding: 0; margin: 0;"`: 移除默认边距，避免广告周围出现空白

#### 步骤 2: 创建 AdBanner 组件

**文件**: `src/components/AdBanner.tsx`

```tsx
'use client';

interface AdBannerProps {
  /**
   * 广告类型
   * banner-468x60: 横幅 468x60
   * banner-300x250: 横幅 300x250
   * banner-160x600: 横幅 160x600 (适合侧边栏)
   * banner-160x300: 横幅 160x300 (适合侧边栏)
   */
  type: 'banner-468x60' | 'banner-300x250' | 'banner-160x600' | 'banner-160x300';
  className?: string;
}

const AD_CONFIGS = {
  'banner-468x60': {
    width: 468,
    height: 60,
  },
  'banner-300x250': {
    width: 300,
    height: 250,
  },
  'banner-160x600': {
    width: 160,
    height: 600,
  },
  'banner-160x300': {
    width: 160,
    height: 300,
  },
};

export function AdBanner({ type, className = '' }: AdBannerProps) {
  const config = AD_CONFIGS[type];

  return (
    <div className={className}>
      <iframe
        src={`/ads/${type}.html`}
        width={config.width}
        height={config.height}
        style={{ border: 'none', overflow: 'hidden' }}
        title={`Adsterra ${type} Banner`}
      />
    </div>
  );
}
```

**组件特点**:
- ✅ 类型安全（TypeScript）
- ✅ 可复用（支持 4 种常见尺寸）
- ✅ 简洁（仅 49 行代码）
- ✅ 可扩展（易于添加新尺寸）

#### 步骤 3: 在页面中使用

**示例 1: 基础用法**
```tsx
import { AdBanner } from '@/components/AdBanner';

export default function DownloadPage() {
  return (
    <div>
      {/* Hero 上方的横幅广告 */}
      <div className="mb-4 flex justify-center">
        <AdBanner type="banner-468x60" />
      </div>

      {/* 页面内容 */}
      <div className="content">
        <h1>页面标题</h1>
        <p>页面内容...</p>
      </div>

      {/* 侧边栏广告 */}
      <aside>
        <AdBanner type="banner-160x600" />
      </aside>
    </div>
  );
}
```

**示例 2: 响应式广告**（根据屏幕尺寸显示不同广告）

**创建响应式 HTML**:
```html
<!-- public/ads/banner-responsive.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsive Adsterra Banner</title>
  <script>
    // 根据窗口宽度动态设置广告配置
    var isMobile = window.innerWidth < 768;
    var atOptions = isMobile
      ? { key: '移动端KEY', format: 'iframe', height: 50, width: 320, params: {} }
      : { key: '桌面端KEY', format: 'iframe', height: 90, width: 728, params: {} };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/KEY/invoke.js"></script>
</head>
<body style="padding: 0; margin: 0;"></body>
</html>
```

**React 组件**:
```tsx
'use client';

import { useEffect, useState } from 'react';

export function ResponsiveAdBanner() {
  const [adSize, setAdSize] = useState({ width: 320, height: 50 });

  useEffect(() => {
    const updateSize = () => {
      const isMobile = window.innerWidth < 768;
      setAdSize(isMobile
        ? { width: 320, height: 50 }
        : { width: 728, height: 90 }
      );
    };

    updateSize();
    window.addEventListener('resize', updateSize);
    return () => window.removeEventListener('resize', updateSize);
  }, []);

  return (
    <iframe
      src="/ads/banner-responsive.html"
      width={adSize.width}
      height={adSize.height}
      style={{ border: 'none', overflow: 'hidden' }}
      title="Responsive Banner"
    />
  );
}
```

---

## 三、常见问题与解决方案

### Q1: 广告不显示怎么办？

**排查步骤**:

1. **检查浏览器控制台**
   ```javascript
   // 打开 DevTools -> Console
   // 查看是否有报错
   ```

2. **验证 HTML 文件可访问**
   - 直接访问: `http://localhost:3000/ads/banner-468x60.html`
   - 应该看到广告或空白区域（广告加载中）

3. **检查网络请求**
   - DevTools -> Network -> 过滤 `invoke.js`
   - 确认请求返回 200 状态码

4. **确认 Adsterra 后台状态**
   - 登录 Adsterra Publisher 后台
   - 检查广告位状态是否为 "Active"
   - 新建广告位通常需要 1-3 小时审核

5. **排查广告拦截器**
   - 禁用浏览器广告拦截插件（如 uBlock Origin、AdBlock）
   - 使用无痕模式测试

### Q2: 同一页面多个广告如何避免冲突？

**解决方案**: iframe 方案天然隔离，每个 iframe 有独立的 `window.atOptions`

```tsx
{/* 不会冲突 - 每个 iframe 是独立上下文 */}
<AdBanner type="banner-468x60" />
<AdBanner type="banner-300x250" />
<AdBanner type="banner-160x600" />
```

**注意事项**:
- ⚠️ 每个广告位必须使用不同的 `key`（从 Adsterra 后台单独申请）
- ⚠️ 避免在同一页面放置过多广告（建议不超过 3 个），影响用户体验和 CPM

### Q3: 广告位置不对或飞到页面底部？

**原因**: 使用了 Next.js Script 组件的 `afterInteractive` 策略

**解决方案**: 使用 iframe 方案，广告位置完全由父容器 CSS 控制

```tsx
{/* 精确控制位置 */}
<div className="flex justify-center my-8">
  <AdBanner type="banner-468x60" />
</div>
```

### Q4: SEO 会受影响吗？

**影响**: iframe 内容不会被搜索引擎索引，但对广告来说这是正常的

**建议**:
- ✅ 广告使用 iframe（不影响 SEO）
- ✅ 重要内容放在主 HTML 中（利于 SEO）
- ✅ 给 iframe 添加 `title` 属性（提升可访问性）

```tsx
<iframe
  src="/ads/banner-468x60.html"
  title="Advertisement Banner"  // ← 帮助屏幕阅读器
  // ...
/>
```

### Q5: 广告加载慢怎么优化？

**优化策略**:

1. **懒加载** - 页面下方的广告延迟加载
```tsx
'use client';

import { useEffect, useRef, useState } from 'react';

export function LazyAdBanner({ type }: { type: string }) {
  const [isVisible, setIsVisible] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsVisible(true);
          observer.disconnect();
        }
      },
      { rootMargin: '200px' }  // 提前 200px 开始加载
    );

    if (containerRef.current) {
      observer.observe(containerRef.current);
    }

    return () => observer.disconnect();
  }, []);

  return (
    <div ref={containerRef}>
      {isVisible && <AdBanner type={type} />}
    </div>
  );
}
```

2. **预连接** - 在 `layout.tsx` 中添加
```tsx
// app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html>
      <head>
        {/* 预连接到 Adsterra 域名 */}
        <link rel="preconnect" href="//www.highperformanceformat.com" />
        <link rel="dns-prefetch" href="//www.highperformanceformat.com" />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

### Q6: 可以在同一页面放多少个广告？

**Adsterra 官方建议**:
- ✅ 同页可放多个 Banner，但要避免广告密度过高
- ✅ 每个广告位使用独立的 `key`（不要复制同一段代码）
- ✅ 建议 1-3 个 Banner + 不同尺寸组合

**最佳实践**:
```tsx
{/* 合理组合：顶部 + 侧边栏 + 底部 */}
<div>
  {/* 顶部横幅 */}
  <AdBanner type="banner-728x90" />

  <div className="flex gap-6">
    {/* 主内容 */}
    <main className="flex-1">
      <p>内容...</p>
    </main>

    {/* 侧边栏广告 */}
    <aside>
      <AdBanner type="banner-160x600" />
    </aside>
  </div>

  {/* 底部横幅 */}
  <AdBanner type="banner-300x250" />
</div>
```

---

## 四、对比其他方案

| 方案 | 可靠性 | 性能 | 复杂度 | 维护性 | 推荐度 |
|------|--------|------|--------|--------|--------|
| **iframe 嵌入** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ **推荐** |
| Next.js Script 组件 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ | ❌ 不推荐 |
| useEffect + innerHTML | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ | ⚠️ 备选 |
| 直接写 `<script>` 标签 | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | ❌ 不推荐 |

**详细对比**:

### iframe 方案（推荐）✅
**优点**:
- ✅ 完全隔离，不受 React 生命周期影响
- ✅ 100% 符合 Adsterra 官方用法
- ✅ 位置可精确控制
- ✅ 实测能赚到广告费
- ✅ 代码简洁易维护

**缺点**:
- ⚠️ iframe 有轻微性能开销（可忽略）
- ⚠️ 需要维护额外的 HTML 文件

### Next.js Script 组件❌
**优点**:
- ✅ 官方推荐的脚本加载方式
- ✅ 支持不同加载策略

**缺点**:
- ❌ `beforeInteractive` 只在根布局生效
- ❌ 组件中使用会被降级
- ❌ 多个 Script 执行顺序不可控
- ❌ 广告可能飞到页面底部

### useEffect + innerHTML⚠️
**优点**:
- ✅ 可以在组件中使用
- ✅ 执行顺序可控

**缺点**:
- ⚠️ 需要手动替换 script 标签才能执行
- ⚠️ 代码复杂，不易维护
- ⚠️ 存在 XSS 风险（如果不小心）

---

## 五、完整示例项目

### 项目结构
```
my-nextjs-app/
├── public/
│   └── ads/
│       ├── banner-468x60.html
│       ├── banner-300x250.html
│       ├── banner-160x600.html
│       └── banner-160x300.html
├── src/
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   └── download/
│   │       └── page.tsx
│   └── components/
│       └── AdBanner.tsx
└── package.json
```

### 完整代码示例

**`public/ads/banner-468x60.html`**:
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adsterra 468x60 Banner</title>
</head>
<body style="padding: 0; margin: 0;">
  <script type="text/javascript">
    atOptions = {
      'key': 'ebb632106ac25ae8ddf3e235720f04bc',
      'format': 'iframe',
      'height': 60,
      'width': 468,
      'params': {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/ebb632106ac25ae8ddf3e235720f04bc/invoke.js"></script>
</body>
</html>
```

**`src/components/AdBanner.tsx`**:
```tsx
'use client';

interface AdBannerProps {
  type: 'banner-468x60' | 'banner-300x250' | 'banner-160x600' | 'banner-160x300';
  className?: string;
}

const AD_CONFIGS = {
  'banner-468x60': { width: 468, height: 60 },
  'banner-300x250': { width: 300, height: 250 },
  'banner-160x600': { width: 160, height: 600 },
  'banner-160x300': { width: 160, height: 300 },
};

export function AdBanner({ type, className = '' }: AdBannerProps) {
  const config = AD_CONFIGS[type];

  return (
    <div className={className}>
      <iframe
        src={`/ads/${type}.html`}
        width={config.width}
        height={config.height}
        style={{ border: 'none', overflow: 'hidden' }}
        title={`Adsterra ${type} Banner`}
      />
    </div>
  );
}
```

**`src/app/download/page.tsx`**:
```tsx
import { AdBanner } from '@/components/AdBanner';

export default function DownloadPage() {
  return (
    <div className="min-h-screen bg-gray-950">
      <div className="container mx-auto px-4 py-8">
        <div className="flex gap-6">
          {/* 主内容区 */}
          <div className="flex-1">
            {/* Hero 上方的横幅 */}
            <div className="mb-4 flex justify-center">
              <AdBanner type="banner-468x60" />
            </div>

            {/* Hero 区域 */}
            <div className="bg-gradient-to-r from-red-500 to-orange-500 p-12 rounded-xl mb-8">
              <h1 className="text-4xl font-bold text-white">下载页面</h1>
              <p className="text-white mt-4">页面内容...</p>
            </div>

            {/* 页面内容 */}
            <div className="prose">
              <p>更多内容...</p>
            </div>
          </div>

          {/* 侧边栏广告 */}
          <aside className="hidden lg:block w-[200px]">
            <div className="sticky top-4">
              <AdBanner type="banner-160x600" />
            </div>
          </aside>
        </div>
      </div>
    </div>
  );
}
```

---

## 六、最佳实践总结

### ✅ DO (推荐做法)

1. **使用 iframe 方案**
   - 为每种广告尺寸创建独立的 HTML 文件
   - 使用可复用的 AdBanner 组件

2. **每个广告位使用独立的 key**
   - 在 Adsterra 后台为每个位置单独申请 Placement
   - 不要复制同一段代码多次使用

3. **合理放置广告**
   - 页面顶部：468×60 或 728×90
   - 侧边栏：160×600（sticky 效果更好）
   - 内容中间：300×250
   - 页面底部：300×250 或原生广告

4. **添加预连接优化**
   ```tsx
   <link rel="preconnect" href="//www.highperformanceformat.com" />
   ```

5. **使用懒加载**
   - 首屏外的广告延迟加载
   - 提升 Core Web Vitals 指标

### ❌ DON'T (避免做法)

1. **不要使用 Next.js Script 组件**
   - 在普通组件中 `beforeInteractive` 无效
   - 执行顺序不可控

2. **不要在 JSX 中直接写 `<script>` 标签**
   - React 会过滤掉
   - 导致 Hydration 错误

3. **不要在同一页面复用同一个广告代码**
   - 违反 Adsterra 政策
   - 导致只显示一个广告

4. **不要放置过多广告**
   - 影响用户体验
   - 降低 CPM 和点击率

5. **不要使用 `document.write`**
   - 会清空整个页面（如果在页面加载后执行）

---

## 七、故障排查清单

遇到问题时，按以下顺序排查：

- [ ] 确认 HTML 文件路径正确（`public/ads/banner-xxx.html`）
- [ ] 检查 Adsterra `key` 是否正确
- [ ] 验证广告尺寸与后台设置一致
- [ ] 确认广告位状态为 "Active"（Adsterra 后台）
- [ ] 禁用浏览器广告拦截器
- [ ] 查看浏览器控制台错误信息
- [ ] 检查网络请求（invoke.js 应返回 200）
- [ ] 直接访问 HTML 文件验证（`/ads/banner-xxx.html`）
- [ ] 等待 1-3 小时（新广告位审核时间）

---

## 八、参考资源

### 官方文档
- [Adsterra Publisher 文档](https://adsterra.com/)
- [Next.js Script 组件文档](https://nextjs.org/docs/pages/building-your-application/optimizing/scripts)
- [React iframe 最佳实践](https://react.dev/learn/you-might-not-need-an-effect)

### 社区资源
- [Stack Overflow: Adsterra in Next.js](https://stackoverflow.com/questions/tagged/adsterra+next.js)
- [GitHub Issues: Next.js beforeInteractive 限制](https://github.com/vercel/next.js/discussions/73671)

---

## 九、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2025-01-15 | 初始版本，基于实战经验总结 |

---

## 十、许可证

本文档采用 MIT 许可证，可自由使用和分享。

---

**一句话总结**:
> 在 Next.js 中集成 Adsterra 广告，使用 iframe 嵌入独立 HTML 文件是最简单、最可靠、最符合官方用法的方案。

**关键代码**（仅需 3 个文件）:
1. `public/ads/banner-xxx.html` - 包含 Adsterra 官方代码
2. `src/components/AdBanner.tsx` - 可复用的 iframe 组件
3. 在页面中使用：`<AdBanner type="banner-468x60" />`

✅ 实测能正常显示广告并赚取收益！